<%
  my( $agentnum, %opt ) = @_;

  my @agents;
  if ( $opt{'agents'} ) {
    #@agents = @{ $opt{'agents'} };
    #here is the agent virtualization
    my $agentnums_href = $FS::CurrentUser::CurrentUser->agentnums_href;
    @agents = grep $agentnums_href->{$_->agentnum}, @{ $opt{'agents'} };
  } else {
    @agents = qsearch( {
      'table'     => 'agent',
      'hashref'   => { disabled=>'' },
      'extra_sql' => ' AND '. $FS::CurrentUser::CurrentUser->agentnums_sql,
    });
  }

%>

<% if ( scalar(@agents) == 1 ) { %>

  <INPUT TYPE="hidden" NAME="agentnum" VALUE="<%= $agents[0]->agentnum %>">

<% } else { %>

  <TR>
    <TD ALIGN="right"><%= $opt{'label'} || 'Agent: ' %></TD>
    <TD>
      <%= include( '/elements/select-agent.html', $agentnum,
                     'agents' => \@agents,
                 )
      %>
    </TD>
  </TR>

<% } %>
