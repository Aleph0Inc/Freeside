<% $data %>
<%init>

my %args = @_;
my $type   = $args{'type'};
my $header = $args{'header'};
my $rows   = $args{'rows'};
my %opt    = %{ $args{'opt'} };    

#http_header('Content-Type' => 'application/excel' ); #eww
#http_header('Content-Type' => 'application/msexcel' ); #alas
#http_header('Content-Type' => 'application/x-msexcel' ); #?

#http://support.microsoft.com/kb/199841
http_header('Content-Type' => 'application/vnd.ms-excel' );

#http://support.microsoft.com/kb/812935
#http://support.microsoft.com/kb/323308
$HTML::Mason::Commands::r->headers_out->{'Cache-control'} = 'max-age=0';

my $data = '';
my $XLS = new IO::Scalar \$data;
my $workbook = Spreadsheet::WriteExcel->new($XLS)
  or die "Error opening .xls file: $!";

my $worksheet = $workbook->add_worksheet(substr($opt{'title'},0,31));

my($r,$c) = (0,0);

$worksheet->write($r, $c++, $_) foreach @$header;

foreach my $row ( @$rows ) {
  $r++;
  $c = 0;

  if ( $opt{'fields'} ) {

    #my $links = $opt{'links'} ? [ @{$opt{'links'}} ] : '';
    #my $aligns = $opt{'align'} ? [ @{$opt{'align'}} ] : '';

    foreach my $field ( @{$opt{'fields'}} ) {
      #my $align = $aligns ? shift @$aligns : '';
      #$align = " ALIGN=$align" if $align;
      #my $a = '';
      #if ( $links ) {
      #  my $link = shift @$links;
      #  $link = &{$link}($row) if ref($link) eq 'CODE';
      #  if ( $link ) {
      #    my( $url, $method ) = @{$link};
      #    if ( ref($method) eq 'CODE' ) {
      #      $a = $url. &{$method}($row);
      #    } else {
      #      $a = $url. $row->$method();
      #    }
      #    $a = qq(<A HREF="$a">);
      #  }
      #}
      if ( ref($field) eq 'CODE' ) {
        foreach my $value ( &{$field}($row) ) {
          if ( ref($value) eq 'ARRAY' ) { 
            $worksheet->write($r, $c++, '(N/A)' ); #unimplemented
          } else {
            $worksheet->write($r, $c++, $value );
          }
        }
      } else {
        $worksheet->write($r, $c++, $row->$field() );
      }
    }

  } else {
    $worksheet->write($r, $c++, $_) foreach @$row;
  }

}

$workbook->close();# or die "Error creating .xls file: $!";

http_header('Content-Length' => length($data) );
 
</%init>
