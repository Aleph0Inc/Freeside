<%

  # options example...
  # 
  ###
  ##req
  ##
  # 'table' => 
  #
  # #? 'primary_key' => #required when the dbdef doesn't know...???
  # #? 'fields' => []
  #
  ###
  ##opt
  ###
  # 'viewall_dir' => '', #'search' or 'browse', defaults to 'search'
  # 'process_m2m' => { 'link_table'   => 'link_table_name',
  #                    'target_table' => 'target_table_name',
  #                  }.

  my(%opt) = @_;

  #false laziness w/edit.html
  my $table = $opt{'table'};
  my $class = "FS::$table";
  my $pkey = dbdef->table($table)->primary_key; #? $opt{'primary_key'} || 
  my $fields = $opt{'fields'}
               #|| [ grep { $_ ne $pkey } dbdef->table($table)->columns ];
               || [ fields($table) ];

  my $pkeyvalue = $cgi->param($pkey);

  my $old = qsearchs( $table, { $pkey => $pkeyvalue } ) if $pkeyvalue;

  my $new = $class->new( {
    map {
      $_, scalar($cgi->param($_));
    } @$fields
  } );

  my $error;
  if ( $pkeyvalue ) {
    $error = $new->replace($old);
  } else {
    $error = $new->insert;
    $pkeyvalue = $new->getfield($pkey);
  }

  if ( !$error && $opt{'process_m2m'} ) {
    $error = $new->process_m2m( %{ $opt{'process_m2m'} },
                                'params' => scalar($cgi->Vars),
                              );
  }

  if ( $error ) {
    $cgi->param('error', $error);
    print $cgi->redirect(popurl(2). "$table.html?". $cgi->query_string );
  } else { 
    print $cgi->redirect( popurl(3).
                          ( $opt{'viewall_dir'} || 'search' ).
                          "/$table.html"
                        );
  }

%>
