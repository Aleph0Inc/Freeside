#!/usr/bin/perl -Tw

use strict;
use FS::UID qw(adminsuidsetup);
use FS::Record qw(qsearch qsearchs);
use FS::part_export;
use FS::svc_acct;
use FS::cust_svc;

my $user = shift or die &usage;
adminsuidsetup $user;

#my $machine = shift or die &usage;

my @exports = qsearch('part_export', { 'exporttype' => 'sqlradius' } );

foreach my $export ( @exports ) {
  my $icradius_dbh = DBI->connect(
    map { $export->option($_) } qw( datasrc username password )
  ) or die $DBI::errstr;
  for my $table (qw( radcheck radreply usergroup )) {
    my $sth = $icradius_dbh->prepare("DELETE FROM $table");
    $sth->execute or die "Can't reset $table table: ". $sth->errstr;
  }
}

foreach my $export ( @exports ) {
  my @svc_acct =
    map { qsearchs('svc_acct', { 'svcnum' => $_->svcnum } ) }
      qsearch('cust_svc', { 'svcpart' => $export->part_svc->svcpart } );
  foreach my $svc_acct ( @svc_acct ) {

    #false laziness with FS::svc_acct::insert (like it matters)
    my $error = $export->export_insert($svc_acct);
    die $error if $error;

  }
}

sub usage {
  #die "Usage:\n\n  sqlradius_reset user machine\n";
  die "Usage:\n\n  sqlradius_reset user\n";
}


